# Development Guide

This document explains how to work with the move-gaussian library, including the Python → Move production cycle.

## Production Cycle Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PYTHON → MOVE WORKFLOW                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. DESIGN (Python)           2. GENERATE (Python)      3. DEPLOY (Move)    │
│  ─────────────────            ────────────────────      ────────────────    │
│                                                                              │
│  • Choose target function     • Scale to WAD (1e18)    • Copy to sources/   │
│  • Run AAA algorithm          • Extract P(x)/Q(x)      • sui move build     │
│  • Validate accuracy          • Generate Move code     • sui move test      │
│  • Check for poles            • Generate test vectors  • Deploy to network  │
│                                                                              │
│  scripts/src/01_*.py          scripts/src/02-07_*.py   sources/*.move       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## When to Run What

### Scenario 1: Bug fix or API change (most common)

Just edit Move code and test:

```bash
# Edit sources/*.move
sui move build
sui move test
```

### Scenario 2: Improve accuracy or add new function

Run full Python pipeline, then update Move:

```bash
# 1. Edit Python pipeline (e.g., change tolerance, add new function)
cd scripts
vim src/01_aaa_exploration.py

# 2. Run pipeline
python run_all.py

# 3. Copy generated files
cp outputs/move_generated/erf_coefficients.move ../sources/
cp outputs/move_generated/erf_tests.move ../tests/

# 4. Update Move API if needed
vim ../sources/erf.move

# 5. Build and test
cd ..
sui move build
sui move test
```

### Scenario 3: Add a new function (e.g., inverse CDF)

1. **Create new AAA exploration**:
   ```python
   # scripts/src/01b_aaa_ppf.py
   from scipy.special import erfinv
   from baryrat import aaa
   
   # Sample the inverse function
   Z = np.linspace(0.001, 0.999, 1000)
   F = erfinv(Z)
   
   r = aaa(Z, F, tol=1e-10)
   ```

2. **Run the full pipeline** (or create parallel pipeline)

3. **Create new Move module**:
   ```move
   // sources/ppf.move
   module gaussian::ppf {
       use gaussian::ppf_coefficients;
       // ...
   }
   ```

## File Responsibilities

### Auto-Generated (DO NOT EDIT MANUALLY)

| File | Generated By | Contains |
|------|--------------|----------|
| `sources/erf_coefficients.move` | `07_export_for_move.py` | P(x), Q(x) coefficients |
| `tests/erf_tests.move` | `07_export_for_move.py` | 100 test vectors |

### Hand-Written

| File | Purpose |
|------|---------|
| `sources/erf.move` | Public API, Horner evaluation |
| `sources/math.move` | Signed arithmetic helpers |
| `Move.toml` | Package manifest |

## Key Design Decisions

### Why AAA Algorithm?

The AAA (Adaptive Antoulas-Anderson) algorithm:
- **Automatic degree selection**: No manual tuning
- **Near-minimax accuracy**: Approaches theoretical best
- **Pole detection**: Avoids numerical instabilities

Result: 5.7e-11 error vs 1.2e-7 for hand-tuned Abramowitz-Stegun.

### Why WAD Scaling (1e18)?

- **DeFi standard**: Compatible with most Sui DeFi protocols
- **18 decimals**: Matches common token precision
- **Overflow safe**: u256 handles intermediate products

### Why Separate Sign Tracking?

Move has no signed integers. We represent -1.5 as:
```move
(magnitude: 1_500_000_000_000_000_000, is_negative: true)
```

This enables signed polynomial coefficients while using unsigned arithmetic.

### Why Degree (11, 11)?

The AAA algorithm automatically selected degree 11 for both P(x) and Q(x):
- **Lower degrees**: Insufficient accuracy
- **Higher degrees**: Marginal improvement, more gas
- **Balanced**: Numerator and denominator have same degree

## Testing Strategy

### Python Tests (Design Phase)

```bash
cd scripts
python src/05_test_harness.py  # Accuracy, edge cases, bounds
python src/06_property_tests.py  # Hypothesis property tests
```

### Move Tests (Runtime Phase)

```bash
sui move test  # All 117 tests
sui move test --filter erf  # Just erf module tests
sui move test --filter math  # Just math module tests
```

### Test Coverage

| Category | Count | Description |
|----------|-------|-------------|
| Generated vectors | 100 | Uniformly sampled x ∈ [0, 6] |
| Math unit tests | 7 | signed_add, mul_div, etc. |
| Erf unit tests | 10 | erf, erfc, phi edge cases |

## Common Issues

### "Duplicate module" error

```
error: duplicate declaration for module 'gaussian::erf_coefficients'
```

**Cause**: Generated `.move` files exist in both `sources/` and `scripts/outputs/`.

**Fix**: Rename or delete the backup files:
```bash
cd scripts/outputs/move_generated
mv erf_coefficients.move erf_coefficients.move.bak
mv erf_tests.move erf_tests.move.bak
```

### "MISSING_DEPENDENCY" test error

```
MISSING_DEPENDENCY error for std::unit_test
```

**Cause**: Explicit Sui dependency in Move.toml doesn't match CLI version.

**Fix**: Remove explicit dependency, let CLI auto-resolve:
```toml
[dependencies]
# No explicit Sui dependency - auto-added by CLI
```

### Accuracy regression after regenerating

**Cause**: AAA tolerance changed, or domain sampled differently.

**Fix**: 
1. Check `outputs/test_results.json` for max_error
2. Compare against previous results in git history
3. Adjust `tol` parameter in `01_aaa_exploration.py`

## Performance Notes

- **Horner evaluation**: O(n) multiplications for degree-n polynomial
- **No loops in Move**: Unrolled coefficient access via if-else chain
- **u256 intermediate values**: Prevents overflow during multiplication

## References

- [AAA Algorithm Paper](https://arxiv.org/abs/1612.00337)
- [baryrat Python library](https://github.com/c-f-h/baryrat)
- [Sui Move Documentation](https://docs.sui.io/concepts/sui-move-concepts)
- [WAD Math Explanation](https://github.com/transmissions11/solmate/blob/main/src/utils/FixedPointMathLib.sol)
